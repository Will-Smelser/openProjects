<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <style>
        .carousel-active{
            background-color: cornflowerblue;
        }
        .carousel-wrapper{
            border:solid black 2px;
        }
        .inner{
            position: absolute;
            top:291px;
        }
        img{
            -ms-transform: rotate(-90deg) scale(0.28); /* IE 9 */
            -webkit-transform: rotate(-90deg) scale(0.28); /* Chrome, Safari, Opera */
            transform: rotate(90deg) scale(0.28);

            -ms-transform-origin: top left;
            -webkit-transform-origin: top left;
            transform-origin: top left;
        }
        .test{
            width:200px;
            display: inline-block;
        }


    </style>
</head>
<body>
<div style="width:100%;border:solid red 2px;overflow:hidden; margin: 0px auto">
    <div id="main" style="width:200%;position:relative;left:-50%;text-align: center">
        <div class="test">HELLO 0</div>
        <div class="test">HELLO 1
            <div style="height:800px;border:solid red 2px;">Some Tall Content</div>
        </div>
        <div class="test">HELLO 2</div>
        <div class="test">HELLO 3</div>
        <div class="test">HELLO 4</div>
    </div>
</div>




<button id="btn">Add Element</button>
<button id="btn2">Remove Element</button>
</body>
<script>

    var Carousel = function(options,$target){
        //allow a css selector or jquery for target
        if(typeof $target === 'string'){
            $target = $($target);
        }

        //default options
        var _opts = {
            showElements:1, //how many to be displayed at one time
            startElement:4,
            animateDuration:1,
            classNameWrapper:'carousel-wrapper',
            classNameActive:'carousel-active',
            classNameShow:'carousel-show',
            classNameHide:'carousel-hide',
            classNameLeft:'carousel-left',
            classNameRight: 'carousel-right',
            debug:true
        };
        $.extend(_opts,options);

        //used for animations
        $('<style>'+
                '.'+_opts.classNameWrapper+'{max-width:0px;transition: max-width '+_opts.animateDuration+'s ease-out; height:0px;vertical-align:top;display:inline-block;overflow:hidden;} '+
                'div.'+_opts.classNameShow+'{max-width:1200px;transition: max-width '+_opts.animateDuration+'s  ease-in; height:auto;} '+
                '.'+_opts.classNameRight+'{overflow:hidden;float:left;} '+
                '.'+_opts.classNameLeft+'{overflow:hidden;float:right;} '+
                '.'+_opts.classNameHide+'{width:0px;max-width:0px;height:0px;} </style>').appendTo('head');

        var $wrapper = $('<div class="'+_opts.classNameWrapper+'" ><div></div></div>');

        $target.children().wrap($wrapper);

        var els = $target.children();

        var log = function(str){
            if(console && _opts.debug){ console.log(str); }
        }

        //calculate how many before and how many after
        var getBeforeAndAfter = function(idx,showCnt,els){
            //ideal before and after
            var before = Math.floor((showCnt-1)/2.0);
            var after = Math.ceil((showCnt-1)/2.0);

            //handle edge cases, shifting before and after as needed
            while(idx - before < 0){
                before--;
                after++;
            }
            while(idx + after > els.length-1){
                before++;
                after--;
            }
            return [before,after];
        };

        var showElems = function(idx,els,showCnt){
            if(idx < 0 || idx >= els.length){
                log("Index out of bounds: "+idx+", min:0, max:"+(els.length-1));
                idx = els.length-1;
                log("Changing index to "+idx);
            }

            //sanity check
            if(showCnt > els.length){
                log("Request to show more elements than available, only showing: "+els.length);
                showCnt = els.length;
            }

            var temp = getBeforeAndAfter(idx,showCnt,els);
            var before = temp[0];
            var after = temp[1];

            //show before, and current
            for(var i=0; i <= before; i++){
                $(els[idx - i]).addClass(_opts.classNameShow);
            }

            //show after
            for(var i=1; i<=after; i++){
                $(els[idx + i]).addClass(_opts.classNameShow)
            }

            $(els[idx]).addClass(_opts.classNameActive);

        }

        $target.append(els);
        showElems(_opts.startElement,els,_opts.showElements);

        this.elements = function(){
            return $target.children();
        }

        this.currentEl = function(){
            return $target.find('.'+_opts.classNameActive);
        }

        this.currentIndex = function(){
            return this.currentEl().index();
        }

        /**
         * Check whether this is a previous slide to show.  This mostly applies to a carousel is displaying more than
         * a single slide visible.  See examples for why this is used.
         */
        this.isPrevNotShown = function(){
            var ideal = Math.floor((_opts.showElements-1)/2.0); //ideal
            var actual = getBeforeAndAfter(this.currentIndex()-1,_opts.showElements,this.elements())[0];
            return (actual === ideal) ? true : false;
        };

        /**
         * Check whether there is next slide to show.  This mostly applies to a carousel is displaying more than
         * a single slide.  If true, then calling next() would trigger a new slide to show.  Returns false if calling
         * next() would merely change which slide is active.  Meaning which slide wrapper has the _opts.classNameActive
         * set.
         * @returns {boolean}
         */
        this.isNextNotShown = function(){
            var ideal = Math.floor((_opts.showElements-1)/2.0); //ideal
            var actual = getBeforeAndAfter(this.currentIndex()-1,_opts.showElements,this.elements())[1];
            return (actual === ideal) ? true : false;
        };

        var animateClose = function($target, dirClass, cb){
            var $inner = $target.children().first().removeAttr('class').addClass(dirClass);

            $target.animate({width:'0px'},_opts.animateDuration*250,'linear',function(){
                $(this).addClass(_opts.classNameHide).removeClass(_opts.classNameShow);
                $(this).removeAttr('style');
                $inner.removeAttr('class');
                if(cb) cb();
            });
        };

        var animateOpen = function($target, dirClass){
            $target.children().first().removeAttr('style').addClass(dirClass);

            //no way to animate to origional width with jQuery (simple way that is)
            $target.addClass(_opts.classNameShow).removeClass(_opts.classNameHide);
        }

        var navigate = function(direction, cb, scope){
            var $defered = $.Deferred();
            var children = scope.elements();
            var $cur = scope.currentEl();
            var idx = $cur.index()+direction;

            if(idx < 0){
                log("Cannot go to negative index");
                return $defered.resolve().promise();
            }else if(idx >= children.length){
                log("cannot navigate to index greater than length.");
                return $defered.resolve()
            }

            var temp = getBeforeAndAfter(idx,_opts.showElements,children);
            var before = temp[0];
            var after = temp[1];

            //hide the trailing element
            if(after+1 < children.length){
                if(direction > 0){
                    animateOpen($(children[idx+after]),_opts.classNameRight);
                }else{
                    animateClose($(children[idx+after+1]),_opts.classNameRight,function(){
                        $defered.resolve();
                    });
                }
            }

            //animate the showing new element
            if(before-1 < idx){
                if(direction > 0){
                    animateClose($(children[idx-before-1]),_opts.classNameLeft,function(){
                        $defered.resolve();
                    });
                }else{
                    animateOpen($(children[idx-before]),_opts.classNameLeft);
                }
            }

            $cur.removeClass(_opts.classNameActive);
            $(children[idx]).addClass(_opts.classNameActive);

            //call the user's callback when animation completes
            if(typeof cb === 'function'){
                $defered.done(function(){cb();});
            }

            return $defered.promise();
        };

        this.prev = function(cb){
            return navigate(-1,cb,this);
        }

        this.next = function(cb){
            return navigate(1,cb,this);
        }

        /**
         * Jump to a specific index.
         * @param {int} index The index to jump to
         */
        this.gotTo = function(index,cb){
            var curIndex = this.currentIndex();

            var direction = (index > curIndex) ? 1 : -1;


            var lastPromise;
            while(index !== curIndex && curIndex >= 0 && curIndex < this.elements().length){
                lastPromise = navigate(direction,null,this);
                curIndex = curIndex+direction;
            }

            if(typeof cb === 'function'){
                lastPromise.done(function(){cb();});
            }

            return lastPromise;
        };

        var wrapElement = function(el){
            var $newEl = $wrapper.clone();
            $newEl.children().first().append(el);
            return $newEl;
        };

        /**
         * Get the upper and lower bound based on active slide
         */
        this.visibleSlideBounds = function(){
            var curIndex = this.currentIndex();
            var upper = curIndex;
            var lower = curIndex;
            var children = this.elements();

            while(upper < children.length && $(children[upper]).hasClass(_opts.classNameShow)){
                upper++;
            }

            while(lower >= 0 && $(children[lower]).hasClass(_opts.classNameShow)){
                lower--;
            }

            return [++lower,--upper];
        };

        this._addBefore = function(index, $el, elements){
            var visibleSlideBounds = this.visibleSlideBounds();
            var curIndex = this.currentIndex();
            var temp = getBeforeAndAfter(curIndex,_opts.showElements,elements);
            var curUpper = curIndex + temp[1];
            var curLower = curIndex - temp[0];
            var before = temp[0];
            var after = temp[1];

            console.log(visibleSlideBounds);

            //check if this index is in view, if not just add it
            if(index <= visibleSlideBounds[0] || index > visibleSlideBounds[1]){
                $(elements[index]).before($el);
                return;
            }

            var $elToHide = $(elements[visibleSlideBounds[1]]);

            $(elements[index]).before($el);
            animateClose($elToHide,_opts.classNameRight,function(){});
            animateOpen($el,_opts.classNameRight);

            if($elToHide.hasClass(_opts.classNameActive)){
                $elToHide.removeClass(_opts.classNameActive);
                $el.addClass(_opts.classNameActive);
            }
        };

        /**
         * Inserts a slide before the given index.  Example:
         * 1.  Index of 0 would put it at the front
         * 2.  Index of 1 would put it as the second element
         *
         * To add to the end, simply give a number greater than or equal to the current number of slides.
         * @param el
         * @param index
         */
        this.addSlide = function(el,index){
            var children = this.elements();
            if(index > children.length) log("Index greater han current length, adding to end");
            if(index < 0){
                log("Negative index given, adding to beginning.");
                index = 0;
            }

            var $newEl = wrapElement(el);

            if(index >= children.length){
                console.log("after");
                index = children.length;
                $(children[index-1]).after($newEl);
            }else{
                console.log("before");
                this._addBefore(index,$newEl,children);
            }
        };

        this.replaceSlide = function(el,index){
            var children = this.elements();
            if(index < 0 || index >= children.length){
                return log("replaceSlide("+index+"): index out of bounds, ignoring...");
            }
            $(children[index]).children().first().empty().append(el);
        };
    };

    var numElements = 3;


    var $el = $('<div class="outer"><div class="inner"><img src="https://storage.googleapis.com/tmap_lcms/080615/2/LcmsResult_OverlayInt_000113.jpg" /></div></div>');
    $('#btn').click(function(){
        var $temp = $el.clone();
        $('#main').prepend($temp);
        $temp.animate({width:'200px'},500);
    });

    $('#btn2').click(function(){
        var $target = $('.outer:first');
        //$target.animate({width:'0px'},500,function(){$(this).remove();})
    });

</script>
</html>